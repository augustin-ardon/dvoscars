<!DOCTYPE html>
<head>
  <meta charset="utf-8">
<script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/multi-select/0.9.12/js/jquery.multi-select.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/multi-select/0.9.12/css/multi-select.css">
  
  <style>
    body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
  </style>
</head>

<body>
   <h1>Hello World</h1>
  <p>
    This project aims at highlighting the <b>lack of diversity</b> in oscar nominations.
  </p>
  <div id="category-selector">
    <select id="category" class="form-control" multiple="multiple">
      <option value="" disabled selected>Choose a category</option>
    </select>
    <button id="validate">Save</button>
  </div>
  <div id="container">
  </div>
  <script> 
    var categories = ["FILM EDITING", "MAKEUP AND HAIRSTYLING", "COSTUME DESIGN", "BEST PICTURE"]
    var margin = {left:20, right:20, top:20, bot:20}
    
    var legend = {M: "blue", X: "green", F:"red"}
    
    // Chart
    var svg = d3.select("#container").append("svg")
      .attr("width", 960)
      .attr("height", 500)
    
    var height = 500 - margin.top - margin.bot,
        width = 960 - margin.left - margin.right,
        barwidth = 2*width/3;
    
    var legend_container = svg.append("g")
    		.attr("class", "legend")
    		.attr("transform", "translate("+ (barwidth+margin.left*3) + ","+ margin.top*3 +")")
    
    legend_container.append("rect")
    		.attr("height", 52)
    		.attr("width", 40)
    		.style("fill", "grey")
    		.style("opacity", 0.7)
    
    legend_container.selectAll("rect.legend")
    		.data(Object.keys(legend)).enter()
    		.append("rect")
    		.attr("class", "legend")
    		.attr("width", 15)
    		.attr("height", 15)
    		.attr("y", (d, i) => 18*i)
    		.attr("fill", x => legend[x])
    
    legend_container.selectAll("text")
    		.data(Object.keys(legend)).enter()
    		.append("text")
    		.attr("x", 20)
        .attr("y", (d, i) => 18*i + 4)
        .attr("dy", ".5em")
        .text(x => x)
    
    var draw = function(categories, data) {
    
        var chartScale = d3.scaleBand()
            .domain(categories)
            .range([height, 0]);

        var x = d3.scaleBand()
            .range([0, barwidth])
            .domain(data.map(function(d) {return d.year}));

        var y = d3.scaleLinear()
            .domain([0, 1])
            .range([chartScale.bandwidth()-margin.top, 0]);

        var yAxis = d3.axisRight(y)
            .ticks(1)
            .tickFormat(d => d*100 + "%");

        var xAxis = d3.axisTop(x)
            .tickValues(x.domain().filter((d,i) => !(i%10)));

        svg.append("g")
          .attr("class", "x-axis")
          .attr("transform", "translate("+ margin.left + "," + (margin.top + 10) + ")")
          .call(xAxis);

        var nested = d3.nest()
        .key(function(d) {return d.award})
        .key(function(d) {return d.year})
        .rollup(function(d) {
          agg = {"M": d3.sum(d.map(function(e) {
            return e.genre == "M"})),
                 "F": d3.sum(d.map(function(e) {
                   return e.genre == "F"})),
                 "X": d3.sum(d.map(function(e) {
                   return e.genre == "X"})),
                 "tot": d.length};
          return agg
        })
        .entries(data);

        var filtered_data = nested.filter(function(d) {
          return categories.includes(d.key)
        });
        console.log(filtered_data);  

        var barChartContainer = svg.append("g")
        .attr("class", "barchart-container")
        .attr("transform", "translate(0," + margin.top +")");

        var barChart = barChartContainer.selectAll("g")
        .data(filtered_data).enter()
        .append("g")
        .attr("class", "barchart")
        .attr("transform", function(d, i) {
          return "translate("+margin.left+"," + chartScale(d.key) + ")";
        });

        barChart.append("rect")
          .attr("height", chartScale.bandwidth()-10)
          .attr("y", 10).attr("width", barwidth)
          .style("fill", "yellow")
          .style("opacity", 0.4);

        barChart.append("g")
          .attr("class", "y-axis")
          .attr("transform", "translate("+ barwidth + "," + (margin.top/2+10) + ")")
          .call(yAxis);

        var yearBar = barChart.selectAll("g.year")
        .data(function(d) {return d.values}).enter()
        .append("g")
        .attr("class", "year")

        // Women
        yearBar.append("rect")
          .attr("class", "women")
          .attr("width", x.bandwidth() - 1)
          .attr("height", function(e, i) {
          return y(0) - y(e.value.F / e.value.tot);
        })
          .attr("x", function(d) {return x(d.key);})
          .attr("y", function(d) {
          return margin.top + y(d.value.F/d.value.tot);
        })
          .style("fill", legend.F);

        // Mixte
        yearBar.append("rect")
          .attr("class", "mixt")
          .attr("width", x.bandwidth() - 1)
          .attr("height", function(e, i) {
          return y(0) - y(e.value.X / e.value.tot);
        })
          .attr("x", function(d) {return x(d.key);})
          .attr("y", function(d) {
          return margin.top + y((d.value.X + d.value.F)/d.value.tot);
        })
          .style("fill", legend.X);

        // Men
        yearBar.append("rect")
          .attr("class", "men")
          .attr("width", x.bandwidth() - 1)
          .attr("height", function(e, i) {
          return y(0) - y(e.value.M / e.value.tot);
        })
          .attr("x", function(d) {return x(d.key)})
          .attr("y", function(d) {
          return margin.top + y((d.value.M+d.value.X+d.value.F)/d.value.tot);
        })
          .style("fill", legend.M);

        var label_container = barChart.append("rect")
        .attr("height", 30)
        .attr("transform", "translate(15, 17)")
        .style("fill", "grey")
        .style("opacity", 0.9);

        barChart.append("text")
          .attr("id", function(d, i) {return "label-"+i})
          .attr("x", 20)
          .attr("y", 30)
          .attr("dy", ".5em")
          .text(function(d) {return d.key})
          .style("font-size", "15px");

        label_container.attr("width", function(d, i) {
          return d3.select("#label-"+i).node().getBBox().width + 10;
        });
    }
    var global_data;
    d3.csv("data.csv", function(error, data) {
      global_data = data
      d3.select("#category").selectAll("option")
        .data(d3.map(data, x => x.award).keys()).enter()
        .append("option")
        .attr("value", x => x)
        .html(x => x);
        });
    
	  $(document).ready(function() {
		    $('#category').multiSelect();
      	$(".ms-selectable").css("width", "300px");
        $(".ms-selection").css({"width": "300px", "position": "absolute", "left": "350px"});
      	$("#validate").on("click", function(d) {
        		var categories = d3.selectAll("li.ms-selected")
            		.nodes()
            		.filter(function(d){
                  	return d.id.includes("selection") && d.id !== "0-selection"
                })
            		.map(function(d) {return d.innerText})
            draw(categories, global_data);
            });
    });
  </script>
</body>
